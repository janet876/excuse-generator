<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Excuse Machine</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Syne:wght@400;700;800&display=swap" rel="stylesheet"/>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg:       #160d28;
      --card:     rgba(34,18,58,0.82);
      --pink:     #f472b6;
      --lavender: #b49ef5;
      --mint:     #6ee7b7;
      --peach:    #fca87a;
      --sky:      #7dd3fc;
      --text:     #f0e8ff;
      --muted:    #9d87c0;
      --border:   rgba(180,140,255,0.18);
      --focus:    rgba(180,140,255,0.28);
    }

    html { scroll-behavior: smooth; }

    body {
      background: #160d28;
      color: var(--text);
      font-family: 'Inter', sans-serif;
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* ── Canvas background ── */
    #bg-canvas {
      position: fixed;
      inset: 0;
      z-index: 0;
      pointer-events: none;
    }

    /* ── Layout ── */
    .wrapper {
      position: relative; z-index: 1;
      max-width: 680px; margin: 0 auto;
      padding: 0 24px 100px;
    }

    /* ── Header ── */
    header {
      padding: 64px 0 12px;
      text-align: center;
    }

    .eyebrow {
      display: inline-block;
      font-family: 'Inter', sans-serif;
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: var(--lavender);
      margin-bottom: 18px;
    }

    h1 {
      font-family: 'Syne', sans-serif;
      font-size: clamp(48px, 10vw, 84px);
      font-weight: 800;
      line-height: 1.0;
      letter-spacing: -0.03em;
      color: var(--text);
      margin-bottom: 12px;
    }

    h1 .accent { color: var(--pink); }

    .tagline {
      font-size: 15px;
      font-weight: 300;
      color: var(--muted);
      letter-spacing: 0.01em;
    }

    /* ── Card ── */
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 24px;
      padding: 38px 38px 34px;
      margin-top: 36px;
      backdrop-filter: blur(28px);
      -webkit-backdrop-filter: blur(28px);
      box-shadow:
        0 1px 0 rgba(255,255,255,0.06) inset,
        0 20px 60px rgba(0,0,0,0.45),
        0 4px 16px rgba(0,0,0,0.3);
    }

    /* ── Labels ── */
    label {
      display: block;
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 8px;
    }

    /* ── Textarea ── */
    textarea {
      width: 100%;
      background: rgba(255,255,255,0.06);
      border: 1px solid var(--border);
      border-radius: 14px;
      color: var(--text);
      font-family: 'Inter', sans-serif;
      font-size: 14px;
      font-weight: 400;
      line-height: 1.7;
      padding: 14px 16px;
      resize: vertical;
      min-height: 110px;
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    textarea:focus {
      border-color: rgba(180,158,245,0.55);
      box-shadow: 0 0 0 3px var(--focus);
    }
    textarea::placeholder { color: rgba(157,135,192,0.5); }

    /* ── Options ── */
    .options-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
      margin-top: 18px;
    }

    select {
      width: 100%;
      background: rgba(255,255,255,0.06);
      border: 1px solid var(--border);
      border-radius: 12px;
      color: var(--text);
      font-family: 'Inter', sans-serif;
      font-size: 13px;
      font-weight: 500;
      padding: 12px 14px;
      outline: none;
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='11' height='7' viewBox='0 0 11 7'%3E%3Cpath d='M1 1l4.5 4.5L10 1' stroke='%23b49ef5' stroke-width='1.5' fill='none' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 13px center;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    select:focus {
      border-color: rgba(180,158,245,0.55);
      box-shadow: 0 0 0 3px var(--focus);
    }
    select option { background: #22123a; color: var(--text); }

    /* ── Button ── */
    .btn-generate {
      width: 100%;
      margin-top: 20px;
      padding: 16px 20px;
      background: linear-gradient(135deg, #c084fc, #e879a0);
      border: none;
      border-radius: 14px;
      color: #fff;
      font-family: 'Syne', sans-serif;
      font-size: 15px;
      font-weight: 700;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      cursor: pointer;
      position: relative;
      overflow: hidden;
      transition: transform 0.15s, box-shadow 0.2s, opacity 0.2s;
      box-shadow: 0 4px 20px rgba(192,132,252,0.35);
    }
    .btn-generate::before {
      content: '';
      position: absolute; inset: 0;
      background: linear-gradient(135deg, rgba(255,255,255,0.12), transparent);
      border-radius: inherit;
    }
    .btn-generate:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 28px rgba(192,132,252,0.45);
    }
    .btn-generate:active { transform: translateY(0); }
    .btn-generate:disabled { opacity: 0.55; cursor: not-allowed; transform: none; }

    /* Shimmer sweep */
    .btn-generate .shimmer {
      position: absolute; inset: 0;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.18), transparent);
      transform: translateX(-100%);
    }
    .btn-generate:not(:disabled):hover .shimmer {
      animation: sweep 0.55s ease forwards;
    }
    @keyframes sweep { to { transform: translateX(100%); } }

    /* ── Error ── */
    .error-box {
      background: rgba(244,63,94,0.12);
      border: 1px solid rgba(244,63,94,0.3);
      border-radius: 12px;
      padding: 13px 16px;
      color: #fda4b0;
      font-size: 13px;
      font-weight: 500;
      margin-top: 14px;
      display: none;
    }
    .error-box.visible { display: block; }

    /* ── Output ── */
    .output-section { margin-top: 26px; display: none; }
    .output-section.visible {
      display: block;
      animation: rise 0.3s cubic-bezier(0.22, 1, 0.36, 1);
    }
    @keyframes rise {
      from { opacity: 0; transform: translateY(10px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    .output-label {
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 10px;
    }

    .excuse-box {
      background: rgba(180,140,255,0.08);
      border: 1px solid rgba(180,140,255,0.22);
      border-radius: 14px;
      padding: 20px 22px;
      font-size: 15px;
      font-weight: 400;
      line-height: 1.8;
      color: var(--text);
      min-height: 80px;
      white-space: pre-wrap;
    }

    .excuse-box .cursor {
      display: inline-block;
      width: 2px; height: 16px;
      background: var(--lavender);
      margin-left: 2px;
      vertical-align: middle;
      animation: blink 0.85s step-end infinite;
    }
    @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0} }

    /* ── Action row ── */
    .action-row {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }

    .btn-action {
      flex: 1;
      padding: 10px 14px;
      background: rgba(255,255,255,0.06);
      border: 1px solid var(--border);
      border-radius: 10px;
      color: var(--muted);
      font-family: 'Inter', sans-serif;
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      cursor: pointer;
      transition: all 0.15s;
    }
    .btn-action:hover {
      background: rgba(180,158,245,0.12);
      color: var(--lavender);
      border-color: rgba(180,158,245,0.35);
    }
    .btn-action.copied { color: var(--mint); border-color: rgba(110,231,183,0.3); }

    /* ── Divider ── */
    .divider {
      display: flex; align-items: center; gap: 14px;
      margin: 32px 0 16px;
      font-size: 10px; font-weight: 600;
      letter-spacing: 0.15em; text-transform: uppercase;
      color: var(--muted);
    }
    .divider::before, .divider::after {
      content: ''; flex: 1; height: 1px;
      background: var(--border);
    }

    /* ── History ── */
    .history-list { display: flex; flex-direction: column; gap: 6px; }

    .history-item {
      background: rgba(255,255,255,0.04);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px 16px;
      font-size: 13px;
      font-weight: 400;
      color: var(--muted);
      line-height: 1.55;
      cursor: pointer;
      transition: all 0.15s;
      display: flex; justify-content: space-between; align-items: flex-start; gap: 12px;
      backdrop-filter: blur(8px);
    }
    .history-item:hover {
      background: rgba(180,158,245,0.1);
      color: var(--text);
      border-color: rgba(180,158,245,0.3);
      transform: translateX(3px);
    }
    .hist-tone {
      font-size: 10px; font-weight: 600;
      letter-spacing: 0.08em; text-transform: uppercase;
      color: var(--lavender);
      background: rgba(155,127,232,0.1);
      border-radius: 6px;
      padding: 3px 8px;
      white-space: nowrap; flex-shrink: 0;
    }

    /* ── Loader ── */
    .loader { display: inline-flex; gap: 4px; align-items: center; margin-left: 8px; }
    .loader span {
      width: 5px; height: 5px; border-radius: 50%;
      background: rgba(255,255,255,0.8);
      animation: bounce 0.7s ease-in-out infinite;
    }
    .loader span:nth-child(2) { animation-delay: 0.14s; }
    .loader span:nth-child(3) { animation-delay: 0.28s; }
    @keyframes bounce { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-5px)} }

    /* ── Footer ── */
    footer {
      text-align: center;
      margin-top: 60px;
      font-size: 12px;
      font-weight: 400;
      letter-spacing: 0.05em;
      color: var(--muted);
    }

    @media (max-width: 480px) {
      .card { padding: 24px 20px; }
      .options-row { grid-template-columns: 1fr; }
      h1 { font-size: 52px; }
    }
  </style>
</head>
<body>

<canvas id="bg-canvas"></canvas>

<div class="wrapper">
  <header>
    <div class="eyebrow">Powered by Groq AI</div>
    <h1>Excuse<br><span class="accent">Machine</span></h1>
    <p class="tagline">your personal alibi, crafted instantly</p>
  </header>

  <div class="card">
    <label for="situation">What happened?</label>
    <textarea
      id="situation"
      placeholder="Describe your situation — forgot your homework, late to a meeting, didn't text back for three days..."
    ></textarea>

    <div class="options-row">
      <div>
        <label for="tone">Tone</label>
        <select id="tone">
          <option value="professional">Professional</option>
          <option value="casual">Casual</option>
          <option value="dramatic">Dramatic</option>
          <option value="funny">Funny</option>
          <option value="technical">Technical / Nerdy</option>
          <option value="sympathetic">Sympathetic</option>
        </select>
      </div>
      <div>
        <label for="audience">Audience</label>
        <select id="audience">
          <option value="boss">Boss / Manager</option>
          <option value="teacher">Teacher / Professor</option>
          <option value="friend">Friend</option>
          <option value="parent">Parent</option>
          <option value="partner">Partner</option>
          <option value="colleague">Colleague</option>
        </select>
      </div>
    </div>

    <button class="btn-generate" id="generateBtn" onclick="generateExcuse()">
      <span class="shimmer"></span>
      Generate Excuse
    </button>

    <div class="error-box" id="errorBox"></div>

    <div class="output-section" id="outputSection">
      <div class="output-label">Your excuse</div>
      <div class="excuse-box" id="excuseBox"></div>
      <div class="action-row">
        <button class="btn-action" id="copyBtn" onclick="copyExcuse()">Copy</button>
        <button class="btn-action" onclick="generateExcuse()">Regenerate</button>
      </div>
    </div>
  </div>

  <div id="historySection" style="display:none;">
    <div class="divider">Recent excuses</div>
    <div class="history-list" id="historyList"></div>
  </div>

  <footer>Use responsibly &mdash; or don't. We're not your boss.</footer>
</div>

<script>
// ─── CONFIG ──────────────────────────────────────────────────────────────────
const GROQ_API_KEY = "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";
const GROQ_MODEL   = "llama-3.1-8b-instant";
// ─────────────────────────────────────────────────────────────────────────────

// ── Dynamic canvas background ────────────────────────────────────────────────
(function() {
  const canvas = document.getElementById("bg-canvas");
  const ctx    = canvas.getContext("2d");

  // Richer, more saturated pastel-on-dark palette
  const COLORS = [
    { r:244, g:114, b:182 }, // hot pink
    { r:167, g:139, b:250 }, // violet
    { r:110, g:231, b:183 }, // mint
    { r:125, g:211, b:252 }, // sky
    { r:252, g:168, b:122 }, // peach
    { r:196, g:132, b:252 }, // purple
  ];

  let W, H;
  const BLOBS   = [];
  const RINGS   = [];
  const N_BLOBS = 8;

  function resize() {
    W = canvas.width  = window.innerWidth;
    H = canvas.height = window.innerHeight;
  }

  function rand(a, b) { return a + Math.random() * (b - a); }

  function createBlob(i) {
    const c = COLORS[i % COLORS.length];
    return {
      x: rand(0.05, 0.95) * W,
      y: rand(0.05, 0.95) * H,
      r: rand(200, 380),
      // faster speeds
      vx: rand(0.4, 1.1) * (Math.random() < 0.5 ? 1 : -1),
      vy: rand(0.4, 1.1) * (Math.random() < 0.5 ? 1 : -1),
      phase: rand(0, Math.PI * 2),
      freq:  rand(0.012, 0.022),   // faster breathing
      amp:   rand(35, 70),         // bigger breath
      cr: c.r, cg: c.g, cb: c.b,
      cphase: rand(0, Math.PI * 2),
      cfreq:  rand(0.007, 0.014),
    };
  }

  // Ripple ring spawned at a blob's centre
  function spawnRing(x, y, color) {
    RINGS.push({ x, y, r: 0, maxR: rand(120, 260), alpha: 0.55,
                 cr: color.r, cg: color.g, cb: color.b,
                 speed: rand(1.4, 2.6) });
  }

  let t = 0;
  let nextRing = 80;

  function init() {
    resize();
    BLOBS.length = 0;
    for (let i = 0; i < N_BLOBS; i++) BLOBS.push(createBlob(i));
  }

  function draw() {
    t++;
    ctx.clearRect(0, 0, W, H);

    // Dark base gradient — shifts over time
    const hShift = Math.sin(t * 0.003) * 30;
    const grad = ctx.createLinearGradient(0, 0, W, H);
    grad.addColorStop(0,   `hsl(${260 + hShift},55%,8%)`);
    grad.addColorStop(0.5, `hsl(${280 + hShift},50%,10%)`);
    grad.addColorStop(1,   `hsl(${240 + hShift},60%,7%)`);
    ctx.fillStyle = grad;
    ctx.fillRect(0, 0, W, H);

    // ── Blobs ──
    BLOBS.forEach((b, idx) => {
      b.x += b.vx;
      b.y += b.vy;

      // wrap
      if (b.x < -b.r * 1.5) b.x = W + b.r;
      if (b.x > W + b.r * 1.5) b.x = -b.r;
      if (b.y < -b.r * 1.5) b.y = H + b.r;
      if (b.y > H + b.r * 1.5) b.y = -b.r;

      const breathe = b.r + Math.sin(t * b.freq + b.phase) * b.amp;
      const shift   = Math.sin(t * b.cfreq + b.cphase) * 30;
      const r  = Math.round(Math.min(255, Math.max(0, b.cr + shift)));
      const g  = Math.round(Math.min(255, Math.max(0, b.cg + shift * 0.6)));
      const bv = Math.round(Math.min(255, Math.max(0, b.cb - shift * 0.4)));

      const rg = ctx.createRadialGradient(b.x, b.y, 0, b.x, b.y, breathe);
      rg.addColorStop(0,    `rgba(${r},${g},${bv},0.55)`);
      rg.addColorStop(0.45, `rgba(${r},${g},${bv},0.28)`);
      rg.addColorStop(0.78, `rgba(${r},${g},${bv},0.1)`);
      rg.addColorStop(1,    `rgba(${r},${g},${bv},0)`);

      ctx.beginPath();
      ctx.arc(b.x, b.y, breathe, 0, Math.PI * 2);
      ctx.fillStyle = rg;
      ctx.fill();

      // spawn occasional ripple
      if (t === nextRing + idx * 14) {
        spawnRing(b.x, b.y, { r, g, b: bv });
      }
    });

    // schedule next ring burst
    if (t >= nextRing + N_BLOBS * 14) nextRing = t + rand(40, 100);

    // ── Ripple rings ──
    for (let i = RINGS.length - 1; i >= 0; i--) {
      const ring = RINGS[i];
      ring.r     += ring.speed;
      ring.alpha  = 0.55 * (1 - ring.r / ring.maxR);

      ctx.beginPath();
      ctx.arc(ring.x, ring.y, ring.r, 0, Math.PI * 2);
      ctx.strokeStyle = `rgba(${ring.cr},${ring.cg},${ring.cb},${ring.alpha})`;
      ctx.lineWidth   = 1.5;
      ctx.stroke();

      if (ring.r >= ring.maxR) RINGS.splice(i, 1);
    }

    // ── Sweeping diagonal lines ──
    ctx.save();
    ctx.globalAlpha = 0.055;
    ctx.strokeStyle = "#b49ef5";
    ctx.lineWidth   = 1;
    const spacing = 55;
    const offset  = (t * 0.45) % spacing;
    for (let x = -spacing * 2 + offset; x < W + spacing; x += spacing) {
      ctx.beginPath();
      ctx.moveTo(x, 0);
      ctx.lineTo(x + H * 0.25, H);
      ctx.stroke();
    }
    ctx.restore();

    // ── Subtle noise vignette ──
    const vig = ctx.createRadialGradient(W/2, H/2, H * 0.3, W/2, H/2, H * 0.85);
    vig.addColorStop(0, "rgba(0,0,0,0)");
    vig.addColorStop(1, "rgba(0,0,0,0.45)");
    ctx.fillStyle = vig;
    ctx.fillRect(0, 0, W, H);

    requestAnimationFrame(draw);
  }

  window.addEventListener("resize", () => { resize(); });
  init();
  draw();
})();

// ── App logic ─────────────────────────────────────────────────────────────────
let excuseHistory = [];
let currentExcuse = "";

async function generateExcuse() {
  const situation = document.getElementById("situation").value.trim();
  const tone      = document.getElementById("tone").value;
  const audience  = document.getElementById("audience").value;

  if (!situation) {
    showError("Please describe your situation first.");
    return;
  }

  const btn           = document.getElementById("generateBtn");
  const errorBox      = document.getElementById("errorBox");
  const outputSection = document.getElementById("outputSection");
  const excuseBox     = document.getElementById("excuseBox");

  errorBox.classList.remove("visible");
  btn.disabled = true;
  btn.innerHTML = `<span class="shimmer"></span>Working on it<span class="loader"><span></span><span></span><span></span></span>`;

  const prompt = `You are a creative excuse generator. A user needs a ${tone} excuse to tell their ${audience}.

Situation: "${situation}"

Write ONE convincing, well-crafted excuse that fits the tone (${tone}) and audience (${audience}).
Keep it between 2–4 sentences. Be creative but believable. Output ONLY the excuse, no intro or labels.`;

  try {
    const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
      method: "POST",
      headers: {
        "Authorization": `Bearer ${GROQ_API_KEY}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        model: GROQ_MODEL,
        messages: [{ role: "user", content: prompt }],
        temperature: 0.9,
        max_tokens: 200,
        stream: true
      })
    });

    if (!response.ok) {
      const err = await response.json();
      throw new Error(err.error?.message || `API error ${response.status}`);
    }

    outputSection.classList.add("visible");
    excuseBox.innerHTML = '<span class="cursor"></span>';
    currentExcuse = "";

    const reader  = response.body.getReader();
    const decoder = new TextDecoder();
    let buffer    = "";

    while (true) {
      const { done, value } = await reader.read();
      if (done) break;
      buffer += decoder.decode(value, { stream: true });
      const lines = buffer.split("\n");
      buffer = lines.pop();
      for (const line of lines) {
        if (!line.startsWith("data: ") || line === "data: [DONE]") continue;
        try {
          const data  = JSON.parse(line.slice(6));
          const delta = data.choices?.[0]?.delta?.content || "";
          currentExcuse += delta;
          excuseBox.innerHTML = escapeHtml(currentExcuse) + '<span class="cursor"></span>';
        } catch {}
      }
    }

    excuseBox.textContent = currentExcuse;
    addToHistory(situation, tone, audience, currentExcuse);

  } catch (err) {
    showError(err.message);
  } finally {
    btn.disabled = false;
    btn.innerHTML = `<span class="shimmer"></span>Generate Excuse`;
  }
}

function showError(msg) {
  const box = document.getElementById("errorBox");
  box.textContent = msg;
  box.classList.add("visible");
}

function escapeHtml(str) {
  return str
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;");
}

async function copyExcuse() {
  if (!currentExcuse) return;
  await navigator.clipboard.writeText(currentExcuse);
  const btn = document.getElementById("copyBtn");
  btn.textContent = "Copied";
  btn.classList.add("copied");
  setTimeout(() => {
    btn.textContent = "Copy";
    btn.classList.remove("copied");
  }, 2000);
}

function addToHistory(situation, tone, audience, excuse) {
  excuseHistory.unshift({ situation, tone, audience, excuse });
  if (excuseHistory.length > 5) excuseHistory.pop();
  renderHistory();
}

function renderHistory() {
  const section = document.getElementById("historySection");
  const list    = document.getElementById("historyList");
  if (excuseHistory.length === 0) { section.style.display = "none"; return; }
  section.style.display = "block";
  list.innerHTML = excuseHistory.map((item, i) => `
    <div class="history-item" onclick="loadHistoryItem(${i})">
      <span>${item.excuse.slice(0, 110)}${item.excuse.length > 110 ? "…" : ""}</span>
      <span class="hist-tone">${item.tone}</span>
    </div>
  `).join("");
}

function loadHistoryItem(index) {
  const item = excuseHistory[index];
  document.getElementById("situation").value = item.situation;
  document.getElementById("tone").value      = item.tone;
  document.getElementById("audience").value  = item.audience;
  currentExcuse = item.excuse;
  document.getElementById("excuseBox").textContent = item.excuse;
  document.getElementById("outputSection").classList.add("visible");
  window.scrollTo({ top: 0, behavior: "smooth" });
}

document.getElementById("situation").addEventListener("keydown", e => {
  if ((e.ctrlKey || e.metaKey) && e.key === "Enter") generateExcuse();
});
</script>
</body>
</html>
